<!--

This is the code you pass to Wearscript to load onto Glass.
It handles input from the touchpad and output to the screen.

-->

<html style="width:100%; height:100%; overflow:hidden">
<head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.9/jquery.transit.min.js"></script>

<script type='text/javascript' src='https://cdn.firebase.com/js/client/1.0.2/firebase.js'></script>

</head>

<body style="width:100%; height:100%; overflow:hidden; margin:0; background-color: black;">
	<div id="status" style="position: absolute; top: 10px; left: 10px; z-index: 1; background-color: black; color: white; padding: 10px; font-size: 40px;">Swipe to Navigate...</div>
	<img id="screen" src="#" style="position: absolute; top: 0; left: 0; z-index: 0; width: 100%;" />
	<div id="url" style="position: absolute; bottom: 10px; left: 10px; z-index: 1; background-color: black; color: white; padding: 5px 20px; font-size: 40px;">Current Slide: Loading...</div>
	<div id="timer" style="position: absolute; bottom: 10px; right: 10px; z-index: 1; background-color: black; color: white; padding: 5px 20px; font-size: 40px;">0:00</div>
<script>
	var fb_root;
	var start_time;

	function respondToGesture(name) {
		fb_root.child('commands').push(name);
		
		var action;
		switch(name) {
				case 'SWIPE_RIGHT':
					action = 'Next Slide';
					break;
				case 'TWO_SWIPE_RIGHT':
					action = 'Jump to End';
					break;
			
				case 'SWIPE_LEFT':
					action = 'Previous Slide';
					break;
				case 'TWO_SWIPE_LEFT':
					action = 'Jump to Beginning';
					break;
				
				case 'TAP':
					action = 'Refresh Screenshot';
					fb_root.child('screencast/force_reload').set(1);
					break;
				
				case 'LONG_PRESS':
					action = 'Restart Timer';
					start_time = Date.now();
					break;
				
				default: 
					action = 'Unknown Gesture: ' + name;
					break;
			}
		
		$('#status').text(action).css({
			opacity: 1
		});
		
		setTimeout(function() {
			$('#status').transition({
				opacity: 0,
				duration: 2000
			});
		}, 1000);
	}
	
	function server() {
		WS.log('Server is connected.');
		
		WS.gestureCallback('onGesture', 'respondToGesture');
	}
	
	function main() {
		if (WS.scriptVersion(0)) return;
		
		fb_root = new Firebase('https://controller.firebaseio.com');
		WS.serverConnect('{{WSUrl}}', 'server');
		
		var prev_loaded = 0;
		
		fb_root.child('screencast').on('value', function(snapshot) {
			var screencast = snapshot.val();
			
			if(!screencast || typeof screencast.current_slide == 'undefined' || typeof screencast.force_reload != 'undefined') return; // This is a partial update, don't update...
			if(screencast.last_updated <= prev_loaded) return; // Race condition.. only load the screenshot if it's newer than our current one
			prev_loaded = screencast.last_updated;
			
			var img_url = 'http://' + screencast.local_ip + '?' + screencast.last_updated;
			$('#screen').attr('src', img_url);
			$('#url').text('Current Slide: ' + (screencast.current_slide+1));
			
			WS.wake();
			WS.activityCreate();
		});
		
		start_time = Date.now();
		setInterval(function() {
			var elapsed_seconds = Math.floor((Date.now() - start_time)/1000);
			
			var minutes = Math.floor(elapsed_seconds / 60);
			var seconds = elapsed_seconds % 60;
			
			if(seconds < 10) seconds = '0' + seconds;
			
			$('#timer').text(minutes + ':' + seconds);
		}, 1000);
	}
	
	window.onload = main;
</script>

</body>
</html>
